<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Projeto Caminho do Bem</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    input, select, button { display: block; margin: 5px 0; padding: 6px; width: 300px; }
    #mainDiv { display: none; margin-top: 20px; }
  </style>
</head>
<body>

<div id="loginDiv">
  <h1>Projeto Caminho do Bem</h1>
  <h2>Login</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="senha" placeholder="Senha">
  <button id="btnLogin">Entrar</button>
</div>

<div id="mainDiv">
  <h1>Área Interna</h1>

  <h2>Cadastrar Pessoa</h2>
  <input type="text" id="nome" placeholder="Nome completo">
  <input type="text" id="cpf" placeholder="CPF">
  <input type="date" id="data_nascimento">
  <input type="text" id="nacionalidade" placeholder="Nacionalidade">
  <input type="text" id="telefone" placeholder="Telefone">
  <input type="text" id="endereco_rua" placeholder="Rua">
  <input type="text" id="endereco_bairro" placeholder="Bairro">
  <input type="text" id="endereco_numero" placeholder="Número">
  <input type="text" id="endereco_cep" placeholder="CEP">
  <input type="text" id="cidade" placeholder="Cidade">
  <textarea id="observacoes" placeholder="Observações"></textarea>

  <label for="oficina">Oficina:</label>
  <select id="oficina"></select>

  <label for="tipo_atendimento">Tipo de Atendimento:</label>
  <select id="tipo_atendimento">
    <option value="Direto">Direto</option>
    <option value="Indireto">Indireto</option>
  </select>

  <button id="btnCadastrar">Cadastrar</button>
  <button onclick="logout()">Sair</button>
</div>

<script>
  // ===== CONEXÃO SUPABASE =====
  const SUPABASE_URL = "https://bkipzmooqahwsxrtzomj.supabase.co";
  const SUPABASE_KEY = "sb_publishable_uLmGAJieXUlYnr0PT8AMUw_TVsDT9mF";
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  console.log("Script carregado");

  // ===== EVENT LISTENERS =====
  document.getElementById('btnLogin').addEventListener('click', async () => {
    const email = document.getElementById('email').value;
    const senha = document.getElementById('senha').value;

    if(!email || !senha) { alert("Preencha email e senha"); return; }

    const { data, error } = await supabase.auth.signInWithPassword({ email, password: senha });

    if(error) { alert("Erro no login: " + error.message); console.log(error); return; }

    console.log("Login OK", data);
    document.getElementById('loginDiv').style.display = 'none';
    document.getElementById('mainDiv').style.display = 'block';

    carregarOficinas();
  });

  // ===== LOGOUT =====
  async function logout() {
    await supabase.auth.signOut();
    document.getElementById('mainDiv').style.display = 'none';
    document.getElementById('loginDiv').style.display = 'block';
  }

  // ===== CARREGAR OFICINAS =====
  async function carregarOficinas() {
    const { data, error } = await supabase.from('oficinas').select('*');
    if(error) { console.log(error); alert("Erro ao carregar oficinas"); return; }

    const sel = document.getElementById('oficina');
    sel.innerHTML = '';
    data.forEach(o => {
      const opt = document.createElement('option');
      opt.value = o.id;
      opt.textContent = o.nome;
      sel.appendChild(opt);
    });
  }

  // ===== CADASTRO DE PESSOA =====
  document.getElementById('btnCadastrar').addEventListener('click', async () => {
    const pessoa = {
      nome: document.getElementById('nome').value,
      cpf: document.getElementById('cpf').value,
      data_nascimento: document.getElementById('data_nascimento').value,
      nacionalidade: document.getElementById('nacionalidade').value,
      telefone: document.getElementById('telefone').value,
      endereco_rua: document.getElementById('endereco_rua').value,
      endereco_bairro: document.getElementById('endereco_bairro').value,
      endereco_numero: document.getElementById('endereco_numero').value,
      endereco_cep: document.getElementById('endereco_cep').value,
      cidade: document.getElementById('cidade').value,
      observacoes: document.getElementById('observacoes').value
    };

    try {
      const { data, error } = await supabase.from('pessoas').insert([pessoa]).select();
      if(error) throw error;

      const pessoa_id = data[0].id;
      const oficina_id = document.getElementById('oficina').value;

      const { error: relError } = await supabase.from('pessoa_oficina').insert([{ pessoa_id, oficina_id }]);
      if(relError) throw relError;

      alert("Pessoa cadastrada com sucesso!");
    } catch(err) {
      console.log(err);
      alert("Erro ao cadastrar: " + err.message);
    }
  });
</script>

</body>
</html>
