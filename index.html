<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Cadastro Caminho do Bem</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    input, select, textarea, button { display: block; margin: 6px 0; padding: 6px; width: 300px; }
    textarea { height: 60px; }
  </style>
</head>
<body>

<h1>Cadastro de Pessoa</h1>

<input type="text" id="nome" placeholder="Nome completo">
<input type="text" id="cpf" placeholder="CPF">
<input type="date" id="data_nascimento">
<input type="text" id="telefone" placeholder="Telefone">
<input type="text" id="endereco_rua" placeholder="Rua">
<input type="text" id="endereco_bairro" placeholder="Bairro">
<input type="text" id="endereco_numero" placeholder="Número">
<input type="text" id="endereco_cep" placeholder="CEP">
<input type="text" id="cidade" placeholder="Cidade">
<textarea id="observacoes" placeholder="Observações"></textarea>

<label for="oficina">Oficina:</label>
<select id="oficina"></select>

<button id="btnCadastrar">Cadastrar</button>

<script>
  // ===== Conexão Supabase =====
  const SUPABASE_URL = "https://bkipzmooqahwsxrtzomj.supabase.co";
  const SUPABASE_KEY = "sb_publishable_uLmGAJieXUlYnr0PT8AMUw_TVsDT9mF";
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  console.log("Supabase Client inicializado");

  // ===== Carregar Oficinas =====
  async function carregarOficinas() {
    const { data, error } = await supabase.from('oficinas').select('*');
    if(error) { console.log(error); alert("Erro ao carregar oficinas"); return; }
    const sel = document.getElementById('oficina');
    sel.innerHTML = '';
    data.forEach(o => {
      const opt = document.createElement('option');
      opt.value = o.id;
      opt.textContent = o.nome;
      sel.appendChild(opt);
    });
  }

  carregarOficinas();

  // ===== Cadastro de Pessoa =====
  document.getElementById('btnCadastrar').addEventListener('click', async () => {
    const pessoa = {
      nome: document.getElementById('nome').value,
      cpf: document.getElementById('cpf').value,
      data_nascimento: document.getElementById('data_nascimento').value,
      telefone: document.getElementById('telefone').value,
      endereco_rua: document.getElementById('endereco_rua').value,
      endereco_bairro: document.getElementById('endereco_bairro').value,
      endereco_numero: document.getElementById('endereco_numero').value,
      endereco_cep: document.getElementById('endereco_cep').value,
      cidade: document.getElementById('cidade').value,
      observacoes: document.getElementById('observacoes').value
    };

    const oficina_id = document.getElementById('oficina').value;

    try {
      // Inserir pessoa
      const { data, error } = await supabase.from('pessoas').insert([pessoa]).select();
      if(error) throw error;

      const pessoa_id = data[0].id;

      // Vincular à oficina
      const { error: relError } = await supabase.from('pessoa_oficina').insert([{ pessoa_id, oficina_id }]);
      if(relError) throw relError;

      alert("Pessoa cadastrada com sucesso!");
    } catch(err) {
      console.log(err);
      alert("Erro ao cadastrar: " + err.message);
    }
  });
</script>

</body>
</html>
