<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Projeto Caminho do Bem</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
body { font-family: Arial; padding: 20px; }
input, select, textarea, button {
display:block;
margin:6px 0;
padding:6px;
width:300px;
}
textarea { height:60px; }
#mainDiv { display:none; margin-top:20px; }
</style>
</head>

<body>

<div id="loginDiv">
<h1>Projeto Caminho do Bem</h1>
<h2>Login</h2>
<input type="email" id="email" placeholder="Email">
<input type="password" id="senha" placeholder="Senha">
<button id="btnLogin">Entrar</button>
</div>

<div id="mainDiv">

<h2>Cadastrar Pessoa</h2>

<input type="text" id="nome" placeholder="Nome completo">
<input type="text" id="cpf" placeholder="CPF">
<input type="date" id="data_nascimento">

<input type="text" id="telefone" placeholder="Telefone">
<input type="text" id="cidade" placeholder="Cidade">

<input type="text" id="endereco_rua" placeholder="Rua">
<input type="text" id="endereco_numero" placeholder="Número">
<input type="text" id="endereco_bairro" placeholder="Bairro">
<input type="text" id="endereco_cep" placeholder="CEP">

<textarea id="observacoes" placeholder="Observações"></textarea>

<label>Oficina</label>
<select id="oficina"></select>

<label>Tipo Atendimento</label>
<select id="tipo_atendimento">
<option value="Psicossocial">Psicossocial</option>
<option value="Educacional">Educacional</option>
<option value="Assistencial">Assistencial</option>
</select>

<label>Direto ou Indireto</label>
<select id="direto_indireto">
<option value="Direto">Direto</option>
<option value="Indireto">Indireto</option>
</select>

<label>Data Atendimento</label>
<input type="date" id="data_atendimento">

<button id="btnCadastrar">Cadastrar Tudo</button>

</div>

<script>

document.addEventListener("DOMContentLoaded", async () => {

const SUPABASE_URL = "https://bkipzmooqahwsxrtzomj.supabase.co";
const SUPABASE_KEY = "sb_publishable_uLmGAJieXUlYnr0PT8AMUw_TVsDT9mF";

const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

console.log("Supabase conectado");

// LOGIN FAKE
document.getElementById("btnLogin").addEventListener("click", ()=>{
document.getElementById("loginDiv").style.display="none";
document.getElementById("mainDiv").style.display="block";
carregarOficinas();
});

// CARREGAR OFICINAS
async function carregarOficinas(){

const {data,error} = await supabaseClient.from("oficinas").select("*");

if(error){
alert("Erro oficinas: "+error.message);
return;
}

const sel = document.getElementById("oficina");
sel.innerHTML="";

data.forEach(o=>{
const opt=document.createElement("option");
opt.value=o.id;
opt.textContent=o.nome;
sel.appendChild(opt);
});

}

// CADASTRAR TUDO
document.getElementById("btnCadastrar").addEventListener("click", async ()=>{

try{

// montar endereco geral
const enderecoCompleto = `
${document.getElementById("endereco_rua").value},
${document.getElementById("endereco_numero").value}
${document.getElementById("endereco_bairro").value}
CEP ${document.getElementById("endereco_cep").value}
`;

// ===== PESSOA =====
const pessoaObj = {
nome: document.getElementById("nome").value,
cpf: document.getElementById("cpf").value,
data_nascimento: document.getElementById("data_nascimento").value,
telefone: document.getElementById("telefone").value,
cidade: document.getElementById("cidade").value,

endereco: enderecoCompleto,

endereco_rua: document.getElementById("endereco_rua").value,
endereco_bairro: document.getElementById("endereco_bairro").value,
endereco_numero: document.getElementById("endereco_numero").value,
endereco_cep: document.getElementById("endereco_cep").value,

observacoes: document.getElementById("observacoes").value
};

const {data:pessoaData,error:pessoaError} =
await supabaseClient.from("pessoas").insert([pessoaObj]).select();

if(pessoaError){
alert("Erro pessoa: "+pessoaError.message);
return;
}

const pessoa_id = pessoaData[0].id;

// ===== RELAÇÃO OFICINA =====
const oficina_id = document.getElementById("oficina").value;

await supabaseClient.from("pessoa_oficina").insert([{
pessoa_id,
oficina_id
}]);

// ===== ATENDIMENTO =====
await supabaseClient.from("atendimentos").insert([{
pessoa_id,
tipo_atendimento: document.getElementById("tipo_atendimento").value,
direto_indireto: document.getElementById("direto_indireto").value,
data: document.getElementById("data_atendimento").value,
descricao: document.getElementById("observacoes").value
}]);

alert("Cadastro completo realizado!");

}catch(err){
console.log(err);
alert("Erro geral: "+err.message);
}

});

});

</script>

</body>
</html>
