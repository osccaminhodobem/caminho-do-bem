<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Projeto Caminho do Bem</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <style>
    body { font-family: Arial; padding: 20px; }
    input, select, textarea, button {
      display: block;
      margin: 6px 0;
      padding: 6px;
      width: 300px;
    }
    textarea { height: 60px; }
    #mainDiv { display: none; margin-top: 20px; }
  </style>
</head>

<body>

<div id="loginDiv">
  <h1>Projeto Caminho do Bem</h1>
  <h2>Login</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="senha" placeholder="Senha">
  <button id="btnLogin">Entrar</button>
</div>

<div id="mainDiv">
  <h1>Área Interna</h1>

  <h2>Cadastrar Pessoa</h2>
  <input type="text" id="nome" placeholder="Nome completo">
  <input type="text" id="cpf" placeholder="CPF">
  <input type="date" id="data_nascimento">
  <input type="text" id="nacionalidade" placeholder="Nacionalidade">
  <input type="text" id="telefone" placeholder="Telefone">
  <input type="text" id="endereco_rua" placeholder="Rua">
  <input type="text" id="endereco_bairro" placeholder="Bairro">
  <input type="text" id="endereco_numero" placeholder="Número">
  <input type="text" id="endereco_cep" placeholder="CEP">
  <input type="text" id="cidade" placeholder="Cidade">
  <textarea id="observacoes" placeholder="Observações"></textarea>

  <label>Oficina:</label>
  <select id="oficina"></select>

  <label>Tipo de Atendimento:</label>
  <select id="tipo_atendimento">
    <option value="Direto">Direto</option>
    <option value="Indireto">Indireto</option>
  </select>

  <button id="btnCadastrar">Cadastrar</button>
</div>

<script>

document.addEventListener("DOMContentLoaded", async () => {

  // ===== SUPABASE =====
  const SUPABASE_URL = "https://bkipzmooqahwsxrtzomj.supabase.co";
  const SUPABASE_KEY = "sb_publishable_uLmGAJieXUlYnr0PT8AMUw_TVsDT9mF";

  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  console.log("Supabase conectado:", supabaseClient);

  // ===== LOGIN FAKE =====
  document.getElementById('btnLogin').addEventListener('click', () => {
    document.getElementById('loginDiv').style.display = 'none';
    document.getElementById('mainDiv').style.display = 'block';
    carregarOficinas();
  });

  // ===== CARREGAR OFICINAS =====
  async function carregarOficinas() {

    console.log("Carregando oficinas...");

    const { data, error } = await supabaseClient
      .from('oficinas')
      .select('*');

    console.log("Oficinas retorno:", data, error);

    if (error) {
      alert("Erro ao carregar oficinas: " + error.message);
      return;
    }

    const sel = document.getElementById('oficina');
    sel.innerHTML = '';

    data.forEach(o => {
      const opt = document.createElement('option');
      opt.value = o.id;
      opt.textContent = o.nome;
      sel.appendChild(opt);
    });
  }

  // ===== CADASTRAR =====
  document.getElementById('btnCadastrar').addEventListener('click', async () => {

    console.log("Botão cadastrar clicado");

    const pessoa = {
      nome: document.getElementById('nome').value,
      cpf: document.getElementById('cpf').value,
      data_nascimento: document.getElementById('data_nascimento').value,
      nacionalidade: document.getElementById('nacionalidade').value,
      telefone: document.getElementById('telefone').value,
      endereco_rua: document.getElementById('endereco_rua').value,
      endereco_bairro: document.getElementById('endereco_bairro').value,
      endereco_numero: document.getElementById('endereco_numero').value,
      endereco_cep: document.getElementById('endereco_cep').value,
      cidade: document.getElementById('cidade').value,
      observacoes: document.getElementById('observacoes').value
    };

    console.log("Pessoa enviada:", pessoa);

    try {

      const { data, error } = await supabaseClient
        .from('pessoas')
        .insert([pessoa])
        .select();

      console.log("Insert pessoas retorno:", data, error);

      if (error) {
        alert("Erro ao salvar pessoa: " + error.message);
        return;
      }

      if (!data || data.length === 0) {
        alert("Não retornou dados da pessoa.");
        return;
      }

      const pessoa_id = data[0].id;
      const oficina_id = document.getElementById('oficina').value;

      const { data: relData, error: relError } = await supabaseClient
        .from('pessoa_oficina')
        .insert([{ pessoa_id, oficina_id }])
        .select();

      console.log("Insert relação retorno:", relData, relError);

      if (relError) {
        alert("Erro ao vincular oficina: " + relError.message);
        return;
      }

      alert("Pessoa cadastrada com sucesso!");

    } catch (err) {
      console.error(err);
      alert("Erro geral: " + err.message);
    }

  });

});

</script>

</body>
</html>
